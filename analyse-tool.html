<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¬ç‰Œ/ç¿»å‰¯è®¡ç®—å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .result {
            background: #f0f8ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }

        .error {
            background: #ffe6e6;
            color: #d00;
        }

        .success {
            background: #e6ffe6;
            color: #060;
        }

        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #005a87;
        }

        input,
        select {
            margin: 5px;
            padding: 5px;
        }

        .rule-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #007cba;
        }

        .tenpai-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .tenpai-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tenpai-item:hover {
            background: #e3f2fd;
            border-color: #007cba;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 124, 186, 0.2);
        }

        .tenpai-tile {
            font-weight: bold;
            color: #007cba;
            font-size: 24px;
        }

        .tenpai-value {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }

        /* å‘å¬æ¨è¿›æ–¹æ¡ˆæ ·å¼ */
        .shanten-improvement {
            margin: 10px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .shanten-improvement:hover {
            background: #e3f2fd;
            border-color: #007cba;
            box-shadow: 0 2px 8px rgba(0, 124, 186, 0.1);
        }

        .improvement-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .improvement-action {
            font-size: 32px;
            font-weight: bold;
            color: #007cba;
        }

        .improvement-result {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .improvement-details {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .draw-tiles {
            margin-top: 8px;
            font-size: 24px;
            color: #007cba;
        }

        .current-hand-improvement {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .current-hand-improvement:hover {
            background: #c8e6c9;
        }

        /* é”™è¯¯ä¿¡æ¯æ ·å¼ */
        .error-message {
            background: #ffe6e6;
            color: #d00;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ff9999;
            text-align: center;
            font-weight: bold;
        }

        .hide {
            display: none !important;
        }

        /* Tileæ ¼å¼çš„å‘å¬é€‰æ‹© */
        .shanten-tile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .shanten-tile {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .shanten-tile:hover {
            background: #e3f2fd;
            border-color: #007cba;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 124, 186, 0.2);
        }

        .shanten-tile.optimal {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .shanten-tile.optimal:hover {
            background: #c8e6c9;
        }

        .tile-display-large {
            font-size: 36px;
            margin-bottom: 4px;
            line-height: 1;
        }

        .tile-info {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        .tile-details {
            font-size: 10px;
            color: #666;
            line-height: 1.2;
        }

        .error-message {
            color: #d32f2f;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: #ffebee;
            border-radius: 4px;
            border: 1px solid #e57373;
        }

        /* æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .detail-section {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-name {
            font-weight: bold;
            color: #333;
        }

        .detail-value {
            color: #007cba;
            font-weight: bold;
        }

        .detail-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }

        .summary-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #007cba;
        }

        .modal-buttons {
            text-align: right;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        /* å¬ç‰Œè¯¦æƒ…å¯¹è¯æ¡†æ ·å¼ */
        .tenpai-detail-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .tenpai-detail-tile {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .tenpai-detail-summary {
            font-size: 18px;
            font-weight: bold;
            color: #007cba;
            margin-bottom: 5px;
        }

        .tenpai-detail-points {
            font-size: 16px;
            color: #666;
        }

        .tenpai-detail-section {
            margin-bottom: 20px;
        }

        .tenpai-detail-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }

        .tenpai-detail-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }

        .tenpai-detail-item {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .tenpai-detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .tenpai-detail-item strong {
            color: #007cba;
        }

        .tenpai-detail-description {
            font-size: 14px;
            color: #666;
            margin-top: 3px;
        }

        .btn-primary {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #005a87;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .tile-display {
            font-size: 32px;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
        }

        .tile-section {
            margin: 5px 0;
        }

        .tile-label {
            font-size:small;
            font-weight: bold;
            margin-right: 10px;
        }

        /* è§„åˆ™è®¾ç½®å¯¹è¯æ¡†æ ·å¼ */
        .rule-settings {
            margin-top: 15px;
        }

        .setting-group {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .setting-group h4 {
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .setting-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item label {
            flex: 1;
            margin-right: 15px;
        }

        .setting-item input[type="number"],
        .setting-item select {
            width: 100px;
        }

        .button-group {
            margin-top: 20px;
            text-align: right;
        }

        .button-group button {
            margin-left: 10px;
            padding: 8px 15px;
        }

        .hide {
            display: none;
        }

        .replacement-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .replacement-item:hover {
            background: #e3f2fd;
            border-color: #007cba;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 124, 186, 0.1);
        }

        .replacement-item .tenpai-tile {
            font-size: 16px;
        }

        .replacement-item .tenpai-value {
            font-size: 12px;
        }

        /* åŠ¨ä½œæŒ‡ç¤ºå™¨æ ·å¼ */
        .tile-action-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #007cba;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2;
        }

        .shanten-tile.discard-tile .tile-action-indicator {
            background: #dc3545;
        }

        .shanten-tile.draw-tile .tile-action-indicator {
            background: #28a745;
        }

        .shanten-tile {
            position: relative;
        }
    </style>
</head>

<body>
    <h1>å¬ç‰Œ/ç¿»å‰¯è®¡ç®—å·¥å…·</h1>

    <div class="rule-selector">
        <h2>è§„åˆ™é€‰æ‹©</h2>
        <label>éº»å°†è§„åˆ™:
            <select id="ruleSelector" onchange="switchRule()">
                <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </select>
        </label>
        <div id="ruleInfo" style="margin-top: 10px; color: #666;"></div>
        <button id="ruleSettingsButton" onclick="showRuleSettingsDialog()" style="margin-top: 10px;">è§„åˆ™è®¾ç½®</button>
    </div>

    <div class="test-section">
        <h2>å¬ç‰Œè®¡ç®—</h2>
        <div>
            <label>æ‰‹ç‰Œï¼š<input type="text" id="tenpaiHandInput" placeholder="ä¾‹ï¼š123m456p789s11zï¼ˆ13å¼ ç‰Œï¼‰"
                    onchange="updateTenpaiDisplay(); calculateTenpai()" /></label><br>
            <label>å‰¯éœ²ï¼š<input type="text" id="tenpaiMeldsInput" placeholder="ä¾‹ï¼š123m,456pï¼ˆå¯é€‰ï¼‰"
                    onchange="updateTenpaiDisplay(); calculateTenpai()" /></label><br>
            <label>æ‘¸ç‰Œï¼š<input type="text" id="tenpaiInInput" placeholder="ä¾‹ï¼š1zï¼ˆå¯ç•™ç©ºï¼‰"
                    onchange="updateTenpaiDisplay(); calculateTenpai()" /></label><br>

            <div id="tenpaiTileDisplay" class="tile-display"></div>

            <h3>æ¸¸æˆçŠ¶æ€:</h3>
            <label>å½“å‰åœˆé£: <select id="tenpaiRoundWind">
                    <option value="east">ä¸œé£</option>
                    <option value="south">å—é£</option>
                    <option value="west">è¥¿é£</option>
                    <option value="north">åŒ—é£</option>
                </select></label>
            <label>é—¨é£: <select id="tenpaiPlayerWind">
                    <option value="east">ä¸œå®¶</option>
                    <option value="south">å—å®¶</option>
                    <option value="west">è¥¿å®¶</option>
                    <option value="north">åŒ—å®¶</option>
                </select></label><br>

            <button onclick="calculateTenpai()">è®¡ç®—å¬ç‰Œ</button>
        </div>
        <div id="tenpaiResult" class="result"></div>
        <div id="errorMessage" class="error-message hide"></div>
        <div id="shantenResult" class="result hide">
            <h3 id="shantenTitle">æœªå¬ç‰Œï¼Œ<span id="shantenNumber">0</span>å‘å¬</h3>
            <div id="replacePlans" style="display: block;">
                <!-- æ›¿æ¢ç‰Œé¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div id="winResult" class="result hide">
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #4CAF50;">
                <h3 style="color: #4CAF50; margin-bottom: 15px;">ğŸ‰ æ­å–œå’Œç‰Œï¼</h3>
                <p style="margin-bottom: 15px; color: #666;">
                    æ‚¨çš„ç‰Œå‹å·²ç»å®Œæˆï¼Œå¯ä»¥è¿›è¡Œç¿»å‰¯è®¡ç®—äº†
                </p>
                
                <div style="margin: 15px 0;">
                    <button id="copyToAnalysisBtn" 
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin: 5px; cursor: pointer;">
                        ğŸ“‹ å¤åˆ¶åˆ°ç¿»å‰¯è®¡ç®—
                    </button>
                    <!-- <button onclick="scrollToAnalysis()" 
                            style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin: 5px; cursor: pointer;">
                        ğŸ” è·³è½¬åˆ°ç¿»å‰¯è®¡ç®—
                    </button> -->
                </div>
                
                <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    ğŸ’¡ æç¤ºï¼šç‚¹å‡»"å¤åˆ¶åˆ°ç¿»å‰¯è®¡ç®—"å¯ä»¥è‡ªåŠ¨å¡«å……ç‰Œå‹æ•°æ®
                </div>
            </div>
        </div>
    </div>


    <div class="test-section" id="analysisSection">
        <h2>ç¿»å‰¯è®¡ç®—</h2>
        <div>
            <label>æ‰‹ç‰Œ: <input type="text" id="handInput" placeholder="ä¾‹ï¼š123m456p789s1122zï¼ˆ13å¼ ï¼‰"
                    onchange="updateTileDisplay()" /></label><br>
            <label>å’Œç‰Œ: <input type="text" id="winTileInput" placeholder="ä¾‹ï¼š2zï¼ˆ1å¼ ï¼‰"
                    onchange="updateTileDisplay()" /></label><br>
            <label>å‰¯éœ²: <input type="text" id="meldsInput" placeholder="ä¾‹ï¼š123m,456pï¼ˆå¯é€‰ï¼‰"
                    onchange="updateTileDisplay()" /></label><br>

            <div id="tileDisplay" class="tile-display"></div>

            <h3>å’Œç‰Œæ¡ä»¶:</h3>
            <div id="win-conditions-analysis" class="win-conditions">
                <!-- å’Œç‰Œæ¡ä»¶å°†ç”±è§„åˆ™ç³»ç»ŸåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <!-- æ·»åŠ è‡ªæ‘¸é€‰é¡¹æ¡† -->
            <div id="win-conditions-extra" class="win-conditions">
                <label>è‡ªæ‘¸<input id="win-cond-zimo" type="checkbox" /></label>
            </div>

            <h3>é£ç‰Œè®¾ç½®:</h3>
            <label>å½“å‰åœˆé£: <select id="roundWind">
                    <option value="east">ä¸œé£</option>
                    <option value="south">å—é£</option>
                    <option value="west">è¥¿é£</option>
                    <option value="north">åŒ—é£</option>
                </select></label>
            <label>å’Œç‰Œè€…é—¨é£: <select id="playerWind">
                    <option value="east">ä¸œå®¶</option>
                    <option value="south">å—å®¶</option>
                    <option value="west">è¥¿å®¶</option>
                    <option value="north">åŒ—å®¶</option>
                </select></label><br>

            <button onclick="testHandAnalysis()">åˆ†æç‰Œå‹</button>
        </div>
        <div id="analysisResult" class="result"></div>
    </div>


    <div class="test-section">
        <h2>åˆ†æ•°è®¡ç®—</h2>
        <div>
            <label>å’Œç‰Œè€…: <select id="winner">
                    <option value="east">ä¸œå®¶</option>
                    <option value="south">å—å®¶</option>
                    <option value="west">è¥¿å®¶</option>
                    <option value="north">åŒ—å®¶</option>
                </select></label><br>
            <label>å‡ºé“³è€…: <select id="payer">
                    <option value="east">ä¸œå®¶</option>
                    <option value="south">å—å®¶</option>
                    <option value="west">è¥¿å®¶</option>
                    <option value="north">åŒ—å®¶</option>
                </select></label><br>
            <label>ç¿»æ•°: <input type="number" id="fanCount" min="0" value="1" /></label>
            <label>å‰¯æ•°: <input type="number" id="fuCount" min="0" value="20" /></label><br>
            <label>å’Œç‰Œæ–¹å¼: <select id="winType">
                    <option value="å’Œç‰Œ">å’Œç‰Œ</option>
                    <option value="è‡ªæ‘¸">è‡ªæ‘¸</option>
                </select></label><br>

            <button onclick="testScoreCalculation()">è®¡ç®—åˆ†æ•°</button>
        </div>
        <div id="scoreResult" class="result"></div>
    </div>

    <!-- è§„åˆ™è®¾ç½®å¯¹è¯æ¡† -->
    <div id="rule-settings-dialog" class="modal" onclick="closeModalOnBackgroundClick(event, 'rule-settings-dialog')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="rule-settings-title">è§„åˆ™è®¾ç½®</h3>
                <span class="close" onclick="closeModal('rule-settings-dialog')">&times;</span>
            </div>
            <div id="rule-settings-container" class="rule-settings">
                <!-- è§„åˆ™è®¾ç½®å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="button-group">
                <button onclick="saveRuleSettings()">ä¿å­˜</button>
                <button onclick="closeModal('rule-settings-dialog')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¬ç‰Œè¯¦æƒ…å¯¹è¯æ¡† -->
    <div id="tenpai-detail-dialog" class="modal" onclick="closeModalOnBackgroundClick(event, 'tenpai-detail-dialog')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="tenpai-detail-title">å¬ç‰Œè¯¦æƒ…</h3>
                <span class="close" onclick="closeModal('tenpai-detail-dialog')">&times;</span>
            </div>
            <div id="tenpai-detail-content">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('tenpai-detail-dialog')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="js/mahjong-parser.js"></script>
    <script src="js/shanten-calculator.js"></script>
    <script src="js/rule-systems/base-rule.js"></script>
    <script src="js/rule-systems/chinese-classical-mahjong-var.js"></script>
    <script src="js/rule-systems/japanese-mahjong.js"></script>
    <script src="js/rule-systems/hong-kong-mahjong.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentRuleSystem = null;
        let mahjongParser = null;
        let shantenCalculator = null;

        // å®šä¹‰è§„åˆ™ç³»ç»Ÿå®¹å™¨
        let availableRuleSystems = {};

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯çš„ç»Ÿä¸€å‡½æ•°
        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hide');
                
                // 5ç§’åè‡ªåŠ¨éšè—é”™è¯¯ä¿¡æ¯
                setTimeout(() => {
                    errorDiv.classList.add('hide');
                }, 5000);
            }
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideErrorMessage() {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.classList.add('hide');
            }
        }

        // æ˜¾ç¤ºå¬ç‰Œç»“æœå¹¶éšè—å‘å¬ç»“æœ
        function showTenpaiResult() {
            const tenpaiDiv = document.getElementById('tenpaiResult');
            const shantenDiv = document.getElementById('shantenResult');
            const winDiv = document.getElementById('winResult');
            if (tenpaiDiv) tenpaiDiv.classList.remove('hide');
            if (shantenDiv) shantenDiv.classList.add('hide');
            if (winDiv) winDiv.classList.add('hide');
            hideErrorMessage();
        }

        // æ˜¾ç¤ºå‘å¬ç»“æœå¹¶éšè—å¬ç‰Œç»“æœ
        function showShantenResult() {
            const tenpaiDiv = document.getElementById('tenpaiResult');
            const shantenDiv = document.getElementById('shantenResult');
            const winDiv = document.getElementById('winResult');
            if (tenpaiDiv) tenpaiDiv.classList.add('hide');
            if (shantenDiv) shantenDiv.classList.remove('hide');
            if (winDiv) winDiv.classList.add('hide');
            
            hideErrorMessage();
        }

        // æ˜¾ç¤ºå’Œç‰Œç»“æœå¹¶éšè—å…¶ä»–ç»“æœ
        function showWinResult() {
            const tenpaiDiv = document.getElementById('tenpaiResult');
            const shantenDiv = document.getElementById('shantenResult');
            const winDiv = document.getElementById('winResult');
            if (tenpaiDiv) tenpaiDiv.classList.add('hide');
            if (shantenDiv) shantenDiv.classList.add('hide');
            if (winDiv) winDiv.classList.remove('hide');
            
            hideErrorMessage();
        }

        // æ˜¾ç¤ºå’Œç‰Œä¿¡æ¯å¹¶å¼•å¯¼ç”¨æˆ·è·³è½¬
        function showWinMessage(hand, melds, winTile = null) {
            // æ˜¾ç¤ºå’Œç‰Œç»“æœåŒºåŸŸ
            showWinResult();
            
            // å‡†å¤‡è‡ªåŠ¨å¡«å……çš„æ•°æ®
            const handInput = hand;
            const winTileInput = winTile || '';
            const meldsInput = melds || '';
            
            // è®¾ç½®å¤åˆ¶æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const copyBtn = document.getElementById('copyToAnalysisBtn');
            if (copyBtn) {
                copyBtn.onclick = function() {
                    copyToAnalysis(handInput, winTileInput, meldsInput);
                };
            }
        }

        // å¤åˆ¶ç‰Œå‹åˆ°ç¿»å‰¯è®¡ç®—åŒºåŸŸ
        function copyToAnalysis(hand, winTile, melds) {
            // ç§»é™¤æ‘¸ç‰Œéƒ¨åˆ†ï¼Œå› ä¸ºç¿»å‰¯è®¡ç®—éœ€è¦13å¼ æ‰‹ç‰Œ+1å¼ å’Œç‰Œ
            let handFor13 = hand;
            let winTileFor1 = winTile;
            
            // å¦‚æœæ²¡æœ‰ç‹¬ç«‹çš„å’Œç‰Œï¼Œä»14å¼ æ‰‹ç‰Œä¸­åˆ†ç¦»å‡ºæœ€åä¸€å¼ ä½œä¸ºå’Œç‰Œ
            if (!winTile && hand.length > 0) {
                const tiles = mahjongParser.parseHand(hand);
                if (tiles.length === 14) {
                    // å–æœ€åä¸€å¼ ä½œä¸ºå’Œç‰Œ
                    const lastTile = tiles[tiles.length - 1];
                    winTileFor1 = tileObjectToString(lastTile);
                    
                    // ä»æ‰‹ç‰Œä¸­ç§»é™¤æœ€åä¸€å¼ 
                    tiles.pop();
                    handFor13 = formatTilesToString(tiles);
                }
            }
            
            // å¡«å……ç¿»å‰¯è®¡ç®—åŒºåŸŸ
            document.getElementById('handInput').value = handFor13;
            document.getElementById('winTileInput').value = winTileFor1;
            document.getElementById('meldsInput').value = melds;
            
            // æ›´æ–°ç¿»å‰¯è®¡ç®—åŒºåŸŸçš„æ˜¾ç¤º
            updateTileDisplay();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification('ç‰Œå‹å·²å¤åˆ¶åˆ°ç¿»å‰¯è®¡ç®—åŒºåŸŸ');
            
            // è·³è½¬åˆ°ç¿»å‰¯è®¡ç®—åŒºåŸŸ
            scrollToAnalysis();
        }
        
        // è·³è½¬åˆ°ç¿»å‰¯è®¡ç®—åŒºåŸŸ
        function scrollToAnalysis() {
            const analysisSection = document.getElementById('analysisSection');
            if (analysisSection) {
                analysisSection.scrollIntoView({ behavior: 'smooth' });
                // é«˜äº®æ˜¾ç¤º
                analysisSection.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    analysisSection.style.backgroundColor = '';
                }, 2000);
            }
        }

        // éšè—æ‰€æœ‰ç»“æœåŒºåŸŸå¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showErrorAndHideResults(message) {
            const tenpaiDiv = document.getElementById('tenpaiResult');
            const shantenDiv = document.getElementById('shantenResult');
            const winDiv = document.getElementById('winResult');
            if (tenpaiDiv) tenpaiDiv.classList.add('hide');
            if (shantenDiv) shantenDiv.classList.add('hide');
            if (winDiv) winDiv.classList.add('hide');
            
            showErrorMessage(message);
        }

        // éº»å°†ç‰ŒUnicodeæ˜ å°„
        const tileUnicodeMap = {
            // ä¸‡å­—ç‰Œ
            '1m': 'ğŸ€‡', '2m': 'ğŸ€ˆ', '3m': 'ğŸ€‰', '4m': 'ğŸ€Š', '5m': 'ğŸ€‹',
            '6m': 'ğŸ€Œ', '7m': 'ğŸ€', '8m': 'ğŸ€', '9m': 'ğŸ€',
            // ç­’å­ç‰Œ
            '1p': 'ğŸ€™', '2p': 'ğŸ€š', '3p': 'ğŸ€›', '4p': 'ğŸ€œ', '5p': 'ğŸ€',
            '6p': 'ğŸ€', '7p': 'ğŸ€Ÿ', '8p': 'ğŸ€ ', '9p': 'ğŸ€¡',
            // æ¡å­ç‰Œ
            '1s': 'ğŸ€', '2s': 'ğŸ€‘', '3s': 'ğŸ€’', '4s': 'ğŸ€“', '5s': 'ğŸ€”',
            '6s': 'ğŸ€•', '7s': 'ğŸ€–', '8s': 'ğŸ€—', '9s': 'ğŸ€˜',
            // å­—ç‰Œ
            '1z': 'ğŸ€€', '2z': 'ğŸ€', '3z': 'ğŸ€‚', '4z': 'ğŸ€ƒ', // ä¸œå—è¥¿åŒ—
            '5z': 'ğŸ€„ï¸', '6z': 'ğŸ€…', '7z': 'ğŸ€†',              // ä¸­å‘ç™½
            // èŠ±ç‰Œ - å››èŠ± (ä½¿ç”¨fæ ‡è¯†ç¬¦ï¼Œ1-4ç¼–å·)
            '1f': 'ğŸ€¢', '2f': 'ğŸ€£', '3f': 'ğŸ€¥', '4f': 'ğŸ€¤', // æ¢…å…°èŠç«¹
            // èŠ±ç‰Œ - å››å­£ (ä½¿ç”¨fæ ‡è¯†ç¬¦ï¼Œ5-8ç¼–å·)
            '5f': 'ğŸ€¦', '6f': 'ğŸ€§', '7f': 'ğŸ€¨', '8f': 'ğŸ€©'  // æ˜¥å¤ç§‹å†¬
        };

        // åˆå§‹åŒ–
        function initializeApp() {
            // åˆå§‹åŒ–è§£æå™¨
            mahjongParser = new MahjongParser();

            // åˆå§‹åŒ–å‘å¬æ•°è®¡ç®—å™¨
            try {
                shantenCalculator = new ShantenCalculator();
                console.log('å‘å¬æ•°è®¡ç®—å™¨åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('å‘å¬æ•°è®¡ç®—å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }

            // åˆå§‹åŒ–è§„åˆ™ç³»ç»Ÿ
            initializeRuleSystems();

            // åŠ è½½ä¹‹å‰é€‰æ‹©çš„è§„åˆ™ï¼ˆå¦‚æœæœ‰ï¼‰
            const savedRule = localStorage.getItem('analyse-tool-rule');
            if (savedRule && availableRuleSystems[savedRule]) {
                document.getElementById('ruleSelector').value = savedRule;
            }

            // åˆ‡æ¢åˆ°é€‰ä¸­çš„è§„åˆ™
            switchRule();
            updateTileDisplay();
            updateTenpaiDisplay();
            
            // ç¡®ä¿æ‰€æœ‰ç»“æœåŒºåŸŸåˆå§‹æ—¶éšè—
            document.getElementById('shantenResult').classList.add('hide');
            document.getElementById('winResult').classList.add('hide');
            
            // æ·»åŠ æµ‹è¯•æŒ‰é’®ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
            //addTestButton();
        }

        // æ˜¾ç¤ºè§„åˆ™è®¾ç½®å¯¹è¯æ¡†
        function showRuleSettingsDialog() {
            if (!currentRuleSystem) {
                alert('è¯·å…ˆé€‰æ‹©è§„åˆ™ç³»ç»Ÿ');
                return;
            }

            // è·å–è§„åˆ™è®¾ç½®å®šä¹‰
            const settings = currentRuleSystem.getSettingsDefinition();
            const container = document.getElementById('rule-settings-container');
            const dialogTitle = document.getElementById('rule-settings-title');

            // è®¾ç½®å¯¹è¯æ¡†æ ‡é¢˜
            dialogTitle.textContent = `${currentRuleSystem.name} - è§„åˆ™è®¾ç½®`;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // ç”Ÿæˆè®¾ç½®ç•Œé¢
            Object.keys(settings).forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'setting-group';
                groupDiv.innerHTML = `<h4>${groupName}</h4>`;

                Object.keys(settings[groupName]).forEach(settingKey => {
                    const setting = settings[groupName][settingKey];
                    const currentValue = currentRuleSystem.settings[settingKey] !== undefined ?
                        currentRuleSystem.settings[settingKey] : setting.default;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'setting-item';

                    let inputHTML = '';
                    if (setting.type === 'boolean') {
                        inputHTML = `<input type="checkbox" id="setting-${settingKey}" ${currentValue ? 'checked' : ''}>`;
                    } else if (setting.type === 'number') {
                        inputHTML = `<input type="number" id="setting-${settingKey}" value="${currentValue}" 
                            min="${setting.min || 0}" max="${setting.max || 9999}" step="1">`;
                    } else if (setting.type === 'select') {
                        inputHTML = `<select id="setting-${settingKey}">`;
                        setting.options.forEach(option => {
                            inputHTML += `<option value="${option.value}" ${option.value === currentValue ? 'selected' : ''}>${option.label}</option>`;
                        });
                        inputHTML += '</select>';
                    }

                    itemDiv.innerHTML = `<label>${setting.label}</label>${inputHTML}`;
                    groupDiv.appendChild(itemDiv);
                });

                container.appendChild(groupDiv);
            });

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            document.getElementById('rule-settings-dialog').style.display = 'block';
        }

        // ä¿å­˜è§„åˆ™è®¾ç½®
        function saveRuleSettings() {
            if (!currentRuleSystem || !currentRuleSystem.getSettingsDefinition) {
                return;
            }

            const settings = currentRuleSystem.getSettingsDefinition();
            const newSettings = {};

            // æ”¶é›†æ‰€æœ‰è®¾ç½®çš„å€¼
            Object.keys(settings).forEach(groupName => {
                Object.keys(settings[groupName]).forEach(settingKey => {
                    const element = document.getElementById(`setting-${settingKey}`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            newSettings[settingKey] = element.checked;
                        } else if (element.type === 'number') {
                            newSettings[settingKey] = parseInt(element.value);
                        } else if (element.tagName === 'SELECT') {
                            newSettings[settingKey] = element.value;
                        }
                    }
                });
            });

            // æ›´æ–°è§„åˆ™ç³»ç»Ÿè®¾ç½®
            if (currentRuleSystem.updateSettings) {
                currentRuleSystem.updateSettings(newSettings);

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ ¼å¼ä¸º "rule-settings-{è§„åˆ™ç³»ç»ŸID}"
                const ruleId = document.getElementById('ruleSelector').value;
                localStorage.setItem(`rule-settings-${ruleId}`, JSON.stringify(currentRuleSystem.settings));
            }

            // å…³é—­å¯¹è¯æ¡†
            closeModal('rule-settings-dialog');

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showResult('ruleInfo', 'è§„åˆ™è®¾ç½®å·²ä¿å­˜', 'success');

            // é‡æ–°è®¡ç®—å½“å‰åˆ†æç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
            setTimeout(() => {
                if (document.getElementById('analysisResult').innerHTML) {
                    testHandAnalysis();
                }
                if (document.getElementById('tenpaiResult').innerHTML) {
                    calculateTenpai();
                }
            }, 100);
        }

        // å…³é—­æ¨¡æ€å¯¹è¯æ¡†
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€å¯¹è¯æ¡†
        function closeModalOnBackgroundClick(event, modalId) {
            if (event.target === event.currentTarget) {
                closeModal(modalId);
            }
        }

        // åˆ‡æ¢è§„åˆ™ç³»ç»Ÿ
        function switchRule() {
            const ruleSelector = document.getElementById('ruleSelector');
            if (!ruleSelector) return;

            const ruleType = ruleSelector.value;

            // æ£€æŸ¥æ‰€é€‰è§„åˆ™æ˜¯å¦å­˜åœ¨
            if (!availableRuleSystems[ruleType]) {
                console.error('è§„åˆ™ç³»ç»Ÿæœªæ‰¾åˆ°:', ruleType);
                return;
            }

            // è®¾ç½®å½“å‰è§„åˆ™ç³»ç»Ÿ
            currentRuleSystem = availableRuleSystems[ruleType];

            // åŠ è½½ä¿å­˜çš„è§„åˆ™è®¾ç½®
            const savedSettings = localStorage.getItem(`rule-settings-${ruleType}`);
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    currentRuleSystem.updateSettings(settings);
                } catch (error) {
                    console.error('åŠ è½½è§„åˆ™è®¾ç½®å¤±è´¥:', error);
                }
            }

            // ä¿å­˜è§„åˆ™é€‰æ‹©
            localStorage.setItem('analyse-tool-rule', ruleType);

            displayRuleInfo();
            updateWinConditions();

            // é‡æ–°è®¡ç®—å½“å‰åˆ†æç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
            setTimeout(() => {
                if (document.getElementById('analysisResult').innerHTML) {
                    testHandAnalysis();
                }
                if (document.getElementById('tenpaiResult').innerHTML) {
                    calculateTenpai();
                }
            }, 100);
        }

        // æ˜¾ç¤ºè§„åˆ™ä¿¡æ¯
        function displayRuleInfo() {
            if (!currentRuleSystem) return;

            const info = document.getElementById('ruleInfo');
            const yaku = currentRuleSystem.getSupportedYaku ? currentRuleSystem.getSupportedYaku() : [];
            const rules = currentRuleSystem.getSpecialRules ? currentRuleSystem.getSpecialRules() : [];

            // æ˜¾ç¤ºé‡è¦è§„åˆ™è®¾ç½®
            let settingsInfo = '';
            if (currentRuleSystem.settings) {
                const settings = currentRuleSystem.settings;

                if (settings.initialScore !== undefined) {
                    settingsInfo += `åˆå§‹åˆ†æ•°: ${settings.initialScore} `;
                }

                if (settings.manganPoints !== undefined) {
                    settingsInfo += `æ»¡è´¯ç‚¹æ•°: ${settings.manganPoints} `;
                }

                // æ˜¾ç¤ºç‰¹æ®Šè§„åˆ™
                if (settings.includeFlowers !== undefined) {
                    settingsInfo += `èŠ±ç‰Œ: ${settings.includeFlowers ? 'å¼€å¯' : 'å…³é—­'} `;
                }
                if (settings.redDora !== undefined) {
                    settingsInfo += `èµ¤å®ç‰Œ: ${settings.redDora ? 'å¼€å¯' : 'å…³é—­'} `;
                }
            }

            info.innerHTML = `
                <strong>${currentRuleSystem.name}</strong><br>
                <small>æ”¯æŒ ${yaku.length} ç§å½¹ç§ï¼Œ${rules.length} æ¡ç‰¹æ®Šè§„åˆ™</small>
                <div style="margin-top: 5px; font-size: 0.9em;">${settingsInfo}</div>
            `;
        }

        // å°†ç‰Œå‹å­—ç¬¦ä¸²è½¬æ¢ä¸ºUnicodeæ˜¾ç¤º
        function convertTilesToUnicode(tileString) {
            if (!tileString) return '';

            let result = [];
            let mahjongParser = window.mahjongParser || new MahjongParser();
            if (mahjongParser) {
                try {
                    const tiles = mahjongParser.parseHand(tileString);
                    return tiles.map(tile => {
                        let tileKey;
                        if (tile.suit === 'flower') {
                            tileKey = `${tile.number}f`;
                        } else if (tile.suit === 'honor') {
                            tileKey = `${tile.number}z`;
                        } else {
                            const suitChar = tile.suit === 'man' ? 'm' :
                                tile.suit === 'pin' ? 'p' :
                                    tile.suit === 'sou' ? 's' : '?';
                            tileKey = `${tile.number}${suitChar}`;
                        }
                        return tileUnicodeMap[tileKey] || tileKey;
                    }).join('');
                } catch (error) {
                    console.warn('Parser failed:', error);
                }
            }

            return result.join(' ');
        }

        // æ›´æ–°ç‰Œå‹æ˜¾ç¤º
        function updateTileDisplay() {
            const hand = document.getElementById('handInput').value;
            const winTile = document.getElementById('winTileInput').value;
            const melds = document.getElementById('meldsInput').value;

            const displayDiv = document.getElementById('tileDisplay');

            let displayContent = '';
            if (hand) {
                displayContent += `<div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(hand)}</div>`;
            }
            if (winTile) {
                displayContent += `<div class="tile-section"><span class="tile-label">å’Œç‰Œ:</span>${convertTilesToUnicode(winTile)}</div>`;
            }
            if (melds) {
                const meldGroups = melds.split(',');
                const meldDisplay = meldGroups.map(meld => convertTilesToUnicode(meld.trim())).join(' | ');
                displayContent += `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${meldDisplay}</div>`;
            }

            displayDiv.innerHTML = displayContent || '<span style="color: #999;">è¯·è¾“å…¥ç‰Œå‹ä»¥æŸ¥çœ‹Unicodeæ˜¾ç¤º</span>';
        }

        // æ›´æ–°å¬ç‰Œæ˜¾ç¤º
        function updateTenpaiDisplay() {
            const hand = document.getElementById('tenpaiHandInput').value;
            const melds = document.getElementById('tenpaiMeldsInput').value;
            const inTile = document.getElementById('tenpaiInInput').value;

            const displayDiv = document.getElementById('tenpaiTileDisplay');

            let displayContent = '';
            if (hand) {
                displayContent += `<div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(hand)}</div>`;
            }
            if (melds) {
                const meldGroups = melds.split(',');
                const meldDisplay = meldGroups.map(meld => convertTilesToUnicode(meld.trim())).join(' | ');
                displayContent += `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${meldDisplay}</div>`;
            }
            if (inTile) {
                displayContent += `<div class="tile-section"><span class="tile-label">æ‘¸ç‰Œ:</span>${convertTilesToUnicode(inTile)}</div>`;
            }

            displayDiv.innerHTML = displayContent || '<span style="color: #999;">è¯·è¾“å…¥ç‰Œå‹ä»¥æŸ¥çœ‹Unicodeæ˜¾ç¤º</span>';
        }

        // æ˜¾ç¤ºå¬ç‰Œç»“æœ
        function displayTenpaiResults(results) {
            const resultDiv = document.getElementById('tenpaiResult');

            if (results.length === 0) {
                showResult('tenpaiResult', 'æœªå‘ç°æœ‰æ•ˆå¬ç‰Œ', 'error');
                return;
            }

            // æŒ‰ç¿»æ•°æ’åºï¼ˆé™åºï¼‰
            results.sort((a, b) => b.fan - a.fan);

            let html = `
                <h4>å¬ç‰Œç»“æœ (å…±${results.length}å¼ ):</h4>
                <div class="tenpai-grid">
            `;

            results.forEach(result => {
                const tileUnicode = convertTilesToUnicode(result.winTile);
                const specialType = currentRuleSystem.getSpecialFanType ? currentRuleSystem.getSpecialFanType(result.fan) : null;
                const fanDisplay = specialType ? specialType.name : `${result.fan}ç¿»`;

                html += `
                    <div class="tenpai-item" onclick="showTenpaiDetail('${result.winTile}', ${JSON.stringify(result).replace(/"/g, '&quot;')})">
                        <div class="tenpai-tile">${tileUnicode} (${result.winTile})</div>
                        <div class="tenpai-value">${fanDisplay} ${result.fu}å‰¯</div>
                    </div>
                `;
            });

            html += '</div>';

            resultDiv.className = 'result success';
            resultDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºå¬ç‰Œè¯¦æƒ…ï¼ˆæ–°ç‰ˆï¼Œæ”¯æŒè¯¦ç»†ä¿¡æ¯ï¼‰
        function showTenpaiDetailNew(index, resultData) {
            const result = typeof resultData === 'string' ? JSON.parse(resultData) : resultData;

            // æ„å»ºç¿»æ•°è¯¦æƒ…
            let fanDetailsHtml = '';
            if (result.fanDetails && result.fanDetails.length > 0) {
                fanDetailsHtml = `
                    <div class="tenpai-detail-section">
                        <h4>ç¿»æ•°æ˜ç»†</h4>
                        <div class="tenpai-detail-list">
                            ${result.fanDetails.map(detail => {
                                const fanDisplay = typeof detail.fan === 'number' ? `${detail.fan}ç¿»` : detail.fan;
                                return `
                                    <div class="tenpai-detail-item">
                                        <strong>${detail.name}</strong>: ${fanDisplay}
                                        ${detail.description ? `<div class="tenpai-detail-description">${detail.description}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // æ„å»ºå‰¯æ•°è¯¦æƒ…
            let fuDetailsHtml = '';
            if (result.fuDetails && result.fuDetails.length > 0) {
                fuDetailsHtml = `
                    <div class="tenpai-detail-section">
                        <h4>å‰¯æ•°æ˜ç»†</h4>
                        <div class="tenpai-detail-list" style="border-left-color: #007cba;">
                            ${result.fuDetails.map(detail => {
                                const fuDisplay = typeof detail.fu === 'number' ? `${detail.fu}å‰¯` : detail.fu;
                                return `
                                    <div class="tenpai-detail-item">
                                        <strong>${detail.name}</strong>: ${fuDisplay}
                                        ${detail.description ? `<div class="tenpai-detail-description">${detail.description}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            const specialType = currentRuleSystem.getSpecialFanType ? currentRuleSystem.getSpecialFanType(result.fan) : null;
            const fanDisplay = specialType ? specialType.name : `${result.fan}ç¿»`;
            
            // æ›´æ–°å¯¹è¯æ¡†æ ‡é¢˜
            document.getElementById('tenpai-detail-title').textContent = `å¬ç‰Œè¯¦æƒ… - ${convertTilesToUnicode(result.tile)} (${result.tile})`;
            
            // æ›´æ–°å¯¹è¯æ¡†å†…å®¹
            document.getElementById('tenpai-detail-content').innerHTML = `
                <div class="tenpai-detail-header">
                    <div class="tenpai-detail-tile">${convertTilesToUnicode(result.tile)}</div>
                    <div class="tenpai-detail-summary">${fanDisplay} ${result.fu}å‰¯</div>
                    <div class="tenpai-detail-points">${result.points}ç‚¹</div>
                </div>
                
                ${fanDetailsHtml}
                ${fuDetailsHtml}
                
                ${(!fanDetailsHtml && !fuDetailsHtml) ? '<div class="tenpai-detail-section"><p style="text-align: center; color: #666;">æ— è¯¦ç»†ä¿¡æ¯</p></div>' : ''}
            `;

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            document.getElementById('tenpai-detail-dialog').style.display = 'block';
        }

        // æ˜¾ç¤ºå¬ç‰Œè¯¦æƒ…ï¼ˆæ—§ç‰ˆï¼Œä¿æŒå…¼å®¹æ€§ï¼‰
        function showTenpaiDetail(winTile, resultData) {
            const result = typeof resultData === 'string' ? JSON.parse(resultData) : resultData;

            let detailHtml = `
                <h4>${convertTilesToUnicode(winTile)} (${winTile}) è¯¦æƒ…:</h4>
                <p><strong>ç¿»æ•°:</strong> ${result.fan} <strong>å‰¯æ•°:</strong> ${result.fu}</p>
            `;

            if (result.fanDetails && result.fanDetails.length > 0) {
                detailHtml += '<h5>ç¿»æ•°æ¥æº:</h5><ul>';
                result.fanDetails.forEach(detail => {
                    detailHtml += `<li>${detail.name}: ${detail.fan}ç¿» (${detail.description})</li>`;
                });
                detailHtml += '</ul>';
            }

            if (result.fuDetails && result.fuDetails.length > 0) {
                detailHtml += '<h5>å‰¯æ•°æ¥æº:</h5><ul>';
                result.fuDetails.forEach(detail => {
                    detailHtml += `<li>${detail.name}: ${detail.fu}å‰¯ (${detail.description})</li>`;
                });
                detailHtml += '</ul>';
            }

            alert(detailHtml.replace(/<[^>]*>/g, '\n').replace(/&quot;/g, '"'));
        }

        // è®¡ç®—å¹¶æ˜¾ç¤ºå‘å¬æ•°
        function calculateAndDisplayShanten(hand, melds, conditions) {
            if (!shantenCalculator) {
                showErrorAndHideResults('å‘å¬æ•°è®¡ç®—å™¨æœªåˆå§‹åŒ–');
                return;
            }

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ‘¸ç‰Œï¼ˆ14å¼ ç‰Œï¼‰
                const inTile = document.getElementById('tenpaiInInput').value.trim();
                const handTiles = mahjongParser.parseHand(hand);
                const totalTiles = handTiles.length + (melds ? mahjongParser.parseHand(melds).length : 0);
                
                console.log('è®¡ç®—å‘å¬æ•°:', hand, melds, inTile, 'æ€»ç‰Œæ•°:', totalTiles);
                
                if (inTile || totalTiles === 14) {
                    // 14å¼ ç‰Œçš„æƒ…å†µ - æ˜¾ç¤ºæ‰“å‡ºæ¯å¼ ç‰Œåçš„å‘å¬æ•°
                    calculateAndDisplayCurrentHandImprovements(hand, inTile, melds, conditions);
                } else if (totalTiles === 13) {
                    // 13å¼ ç‰Œçš„æƒ…å†µ - æ˜¾ç¤ºæ‘¸ç‰Œæ¨è¿›æ–¹æ¡ˆ
                    const shantenResult = shantenCalculator.calculate(hand, melds);
                    console.log('å‘å¬æ•°è®¡ç®—ç»“æœ:', shantenResult);
                    
                    // æ˜¾ç¤ºå‘å¬ç»“æœ
                    showShantenResult();
                    document.getElementById('shantenNumber').textContent = shantenResult.shanten;

                    if (shantenResult.improvements && shantenResult.improvements.length > 0) {
                        displayDrawTileImprovements(shantenResult.improvements, shantenResult.shanten, hand, melds);
                    } else {
                        const replacePlansDiv = document.getElementById('replacePlans');
                        replacePlansDiv.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— ä¼˜åŒ–å»ºè®®</p>';
                    }
                } else {
                    throw new Error(`æ— æ•ˆç‰Œæ•°: ${totalTiles}å¼ ç‰Œï¼Œå¿…é¡»ä¸º13æˆ–14å¼ `);
                }

            } catch (error) {
                console.error('å‘å¬æ•°è®¡ç®—é”™è¯¯:', error);
                showErrorAndHideResults(`è®¡ç®—é”™è¯¯: ${error.message}`);
            }
        }

        // è®¡ç®—å¹¶æ˜¾ç¤ºå½“å‰æ‰‹ç‰Œï¼ˆ14å¼ ï¼‰çš„æ”¹è¿›æ–¹æ¡ˆ
        function calculateAndDisplayCurrentHandImprovements(hand, inTile, melds, conditions) {
            try {
                // æ„å»ºå®Œæ•´çš„14å¼ æ‰‹ç‰Œ
                let fullHand = hand;
                if (inTile) {
                    fullHand = hand + inTile;
                }
                
                const handTiles = mahjongParser.parseHand(fullHand);
                if (handTiles.length !== 14) {
                    throw new Error(`æ‰‹ç‰Œåº”ä¸º14å¼ ï¼Œå½“å‰ä¸º${handTiles.length}å¼ `);
                }
                
                // è®¡ç®—å½“å‰å‘å¬æ•°
                const currentShanten = shantenCalculator.calculate(fullHand, melds);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å’Œç‰Œï¼ˆå‘å¬æ•°ä¸º-1ï¼‰
                if (currentShanten.shanten === -1) {
                    showWinMessage(fullHand, melds, inTile);
                    return;
                }
                
                // æ˜¾ç¤ºå‘å¬ç»“æœ
                showShantenResult();
                document.getElementById('shantenNumber').textContent = currentShanten.shanten;

                // ç°åœ¨æ”¹ç”¨å‘å¬æ•°è®¡ç®—å™¨è¿”å›çš„æ”¹è¿›æ–¹æ¡ˆï¼Œåªè¦æ ¼å¼è½¬æ¢
                // ä» {discard: '4p', tiles: [{ tile: '5p', shanten: 1 }, ...]} è½¬æ¢ä¸º { discardTile, resultingHand, resultingShanten, improvements }
                const discardOptions = currentShanten.improvements.map(improvement => {
                    return {
                        discardTile: improvement.discard,
                        resultingHand: removeOneTileFromHand(fullHand, improvement.discard),
                        resultingShanten: improvement.shanten,
                        improvements: improvement.tiles || []
                    };
                });
                
                // æŒ‰å‘å¬æ•°æ’åºï¼Œç›¸åŒå‘å¬æ•°æ—¶æŒ‰å‰©ä½™æšæ•°æ’åº
                discardOptions.sort((a, b) => {
                    // é¦–å…ˆæŒ‰å‘å¬æ•°æ’åºï¼ˆè¶Šå°è¶Šå¥½ï¼‰
                    if (a.resultingShanten !== b.resultingShanten) {
                        return a.resultingShanten - b.resultingShanten;
                    }

                    // è®¡ç®—æ¯ä¸ªé€‰é¡¹çš„æ€»å‰©ä½™æšæ•°
                    const melds = document.getElementById('tenpaiMeldsInput').value;
                    
                    let aTotalRemaining = 0;
                    if (a.resultingShanten === 0) {
                        // å¬ç‰Œæƒ…å†µï¼šè®¡ç®—å¬ç‰Œæšæ•°
                        const aTenpaiTiles = calculateAllTenpaiTiles(a.resultingHand, '', getTenpaiConditions());
                        const aUniqueTenpaiTiles = [...new Set(aTenpaiTiles.map(t => t.tile || t.winTile))];
                        for (const tile of aUniqueTenpaiTiles) {
                            if (tile) {
                                aTotalRemaining += calculateRemainingTiles(tile, a.resultingHand, melds);
                            }
                        }
                    } else {
                        // éå¬ç‰Œæƒ…å†µï¼šè®¡ç®—è¿›å¼ æšæ•°
                        for (const improvement of a.improvements) {
                            aTotalRemaining += calculateRemainingTiles(improvement.tile, a.resultingHand, melds);
                        }
                    }
                    
                    let bTotalRemaining = 0;
                    if (b.resultingShanten === 0) {
                        // å¬ç‰Œæƒ…å†µï¼šè®¡ç®—å¬ç‰Œæšæ•°
                        const bTenpaiTiles = calculateAllTenpaiTiles(b.resultingHand, '', getTenpaiConditions());
                        const bUniqueTenpaiTiles = [...new Set(bTenpaiTiles.map(t => t.tile || t.winTile))];
                        for (const tile of bUniqueTenpaiTiles) {
                            if (tile) {
                                bTotalRemaining += calculateRemainingTiles(tile, b.resultingHand, melds);
                            }
                        }
                    } else {
                        // éå¬ç‰Œæƒ…å†µï¼šè®¡ç®—è¿›å¼ æšæ•°
                        for (const improvement of b.improvements) {
                            bTotalRemaining += calculateRemainingTiles(improvement.tile, b.resultingHand, melds);
                        }
                    }

                    // æŒ‰æ€»å‰©ä½™æšæ•°æ’åºï¼ˆè¶Šå¤šè¶Šå¥½ï¼‰
                    if (aTotalRemaining !== bTotalRemaining) {
                        return bTotalRemaining - aTotalRemaining;
                    }

                    // å‰©ä½™æšæ•°ç›¸åŒæ—¶ï¼ŒæŒ‰æ”¹è¿›æ–¹æ¡ˆçš„æ•°é‡æ’åºï¼ˆè¶Šå¤šè¶Šå¥½ï¼‰
                    if (a.improvements.length !== b.improvements.length) {
                        return b.improvements.length - a.improvements.length;
                    }
                    
                    // æœ€åæŒ‰èŠ±è‰²å’Œæ•°å­—æ’åº
                    const aParsed = parseTileForSort(a.discardTile);
                    const bParsed = parseTileForSort(b.discardTile);
                    
                    // èŠ±è‰²æ’åºä¼˜å…ˆçº§ï¼šm < p < s < z < f
                    const suitOrder = { 'm': 1, 'p': 2, 's': 3, 'z': 4, 'f': 5 };
                    const aSuitOrder = suitOrder[aParsed.suit] || 6;
                    const bSuitOrder = suitOrder[bParsed.suit] || 6;
                    
                    if (aSuitOrder !== bSuitOrder) {
                        return aSuitOrder - bSuitOrder;
                    }
                    
                    // èŠ±è‰²ç›¸åŒæ—¶æŒ‰æ•°å­—æ’åº
                    return aParsed.number - bParsed.number;
                });
                
                displayCurrentHandImprovements(discardOptions, currentShanten.shanten);
                
            } catch (error) {
                console.error('å½“å‰æ‰‹ç‰Œå‘å¬è®¡ç®—é”™è¯¯:', error);
                showErrorAndHideResults(`è®¡ç®—é”™è¯¯: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºå½“å‰æ‰‹ç‰Œçš„æ‰“ç‰Œé€‰æ‹©
        function displayCurrentHandImprovements(discardOptions, currentShanten) {
            const replacePlansDiv = document.getElementById('replacePlans');
            
            if (!discardOptions || discardOptions.length === 0) {
                replacePlansDiv.innerHTML = '<p style="color: #666; text-align: center;">æ— å¯ç”¨é€‰æ‹©</p>';
                return;
            }

            // æ‰¾åˆ°æœ€ä¼˜å‘å¬æ•°
            const bestShanten = Math.min(...discardOptions.map(o => o.resultingShanten));
            
            // è®¡ç®—æ¯ä¸ªé€‰é¡¹çš„æ€»å‰©ä½™æšæ•°ï¼Œæ‰¾åˆ°æœ€å¤§å€¼
            const melds = document.getElementById('tenpaiMeldsInput').value;
            let bestRemainingTiles = 0;
            
            discardOptions.forEach(option => {
                if (option.resultingShanten === bestShanten) {
                    let totalRemaining = 0;
                    if (option.resultingShanten === 0) {
                        // å¬ç‰Œæƒ…å†µï¼šè®¡ç®—å¬ç‰Œæšæ•°
                        const tenpaiTiles = calculateAllTenpaiTiles(option.resultingHand, '', getTenpaiConditions());
                        const uniqueTenpaiTiles = [...new Set(tenpaiTiles.map(t => t.tile || t.winTile))];
                        for (const tile of uniqueTenpaiTiles) {
                            if (tile) {
                                totalRemaining += calculateRemainingTiles(tile, option.resultingHand, melds);
                            }
                        }
                    } else {
                        // éå¬ç‰Œæƒ…å†µï¼šè®¡ç®—è¿›å¼ æšæ•°
                        for (const improvement of option.improvements) {
                            totalRemaining += calculateRemainingTiles(improvement.tile, option.resultingHand, melds);
                        }
                    }
                    bestRemainingTiles = Math.max(bestRemainingTiles, totalRemaining);
                }
            });
            
            let html = `
                <div class="shanten-tile-grid">
            `;
            
            discardOptions.forEach(option => {
                const discardUnicode = convertTilesToUnicode(option.discardTile);
                const shantenChange = option.resultingShanten - currentShanten;
                
                // è®¡ç®—å½“å‰é€‰é¡¹çš„å‰©ä½™æšæ•°
                let currentRemainingTiles = 0;
                if (option.resultingShanten === 0) {
                    const tenpaiTiles = calculateAllTenpaiTiles(option.resultingHand, '', getTenpaiConditions());
                    const uniqueTenpaiTiles = [...new Set(tenpaiTiles.map(t => t.tile || t.winTile))];
                    for (const tile of uniqueTenpaiTiles) {
                        if (tile) {
                            currentRemainingTiles += calculateRemainingTiles(tile, option.resultingHand, melds);
                        }
                    }
                } else {
                    for (const improvement of option.improvements) {
                        currentRemainingTiles += calculateRemainingTiles(improvement.tile, option.resultingHand, melds);
                    }
                }
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºæœ€ä¼˜é€‰æ‹©ï¼ˆæœ€ä¼˜å‘å¬æ•°ä¸”æœ€å¤šå‰©ä½™æšæ•°ï¼‰
                const isOptimal = option.resultingShanten === bestShanten && currentRemainingTiles === bestRemainingTiles;
                
                // è®¡ç®—è¿›å¼ ä¿¡æ¯ï¼ˆä½¿ç”¨å·²è®¡ç®—çš„å‰©ä½™æšæ•°ï¼‰
                let drawInfo = '';
                if (option.resultingShanten === 0) {
                    // å¦‚æœå·²ç»å¬ç‰Œï¼Œæ˜¾ç¤ºå¬ç‰Œä¿¡æ¯
                    const tenpaiTiles = calculateAllTenpaiTiles(option.resultingHand, '', getTenpaiConditions());
                    drawInfo = `å¬${tenpaiTiles.length}ç§ç‰Œ(${currentRemainingTiles}æš)`;
                } else if (option.improvements.length > 0) {
                    // æ˜¾ç¤ºè¿›å¼ ä¿¡æ¯
                    drawInfo = `${option.improvements.length}ç§è¿›å¼ (${currentRemainingTiles}æš)`;
                } else {
                    drawInfo = 'æ— è¿›å¼ ';
                }
                
                html += `
                    <div class="shanten-tile discard-tile ${isOptimal ? 'optimal' : ''}" 
                         onclick="applyDiscardChoice('${option.discardTile}', '${option.resultingHand}')">
                        <div class="tile-action-indicator">æ‰“å‡º</div>
                        <div class="tile-display-large">${discardUnicode}</div>
                        <div class="tile-info">
                            ${option.resultingShanten}å‘å¬
                            ${shantenChange === 0 ? '' : 
                              shantenChange > 0 ? ` (+${shantenChange})` : ` (${shantenChange})`}
                        </div>
                        <div class="tile-details">
                            ${drawInfo}
                            ${isOptimal ? '<br>â­ æœ€ä¼˜' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            replacePlansDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºæ‘¸ç‰Œæ¨è¿›æ–¹æ¡ˆï¼ˆ13å¼ ç‰Œæƒ…å†µï¼‰
        function displayDrawTileImprovements(improvements, currentShanten, hand, melds) {
            const replacePlansDiv = document.getElementById('replacePlans');
            
            if (!improvements || improvements.length === 0) {
                replacePlansDiv.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— ä¼˜åŒ–å»ºè®®</p>';
                return;
            }

            // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„æ‘¸ç‰Œ
            const drawTileOptions = new Map();
            
            improvements.forEach(improvement => {
                improvement.tiles.forEach(tile => {
                    if (!drawTileOptions.has(tile.tile)) {
                        drawTileOptions.set(tile.tile, []);
                    }
                    drawTileOptions.get(tile.tile).push({
                        discard: improvement.discard,
                        shanten: tile.shanten
                    });
                });
            });
            
            // æ‰¾åˆ°æœ€ä¼˜å‘å¬æ•°å’Œæœ€å¤šå‰©ä½™æšæ•°
            let bestShanten = currentShanten;
            let bestRemainingCount = 0;
            
            for (const [drawTile, options] of drawTileOptions.entries()) {
                const minShanten = Math.min(...options.map(o => o.shanten));
                bestShanten = Math.min(bestShanten, minShanten);
                
                // å¦‚æœæ˜¯æœ€ä¼˜å‘å¬æ•°ï¼Œè®¡ç®—å‰©ä½™æšæ•°
                if (minShanten === bestShanten) {
                    const remainingCount = calculateRemainingTiles(drawTile, hand, melds);
                    bestRemainingCount = Math.max(bestRemainingCount, remainingCount);
                }
            }
            
            let html = `
                <div class="shanten-tile-grid">
            `;
            
            // æŒ‰å‘å¬æ•°å’Œå‰©ä½™æšæ•°æ’åºæ˜¾ç¤ºæ‘¸ç‰Œé€‰æ‹©
            const sortedDrawTiles = [...drawTileOptions.keys()].sort((a, b) => {
                const aOptions = drawTileOptions.get(a);
                const bOptions = drawTileOptions.get(b);
                const aBestShanten = Math.min(...aOptions.map(o => o.shanten));
                const bBestShanten = Math.min(...bOptions.map(o => o.shanten));
                
                // é¦–å…ˆæŒ‰å‘å¬æ•°æ’åºï¼ˆè¶Šå°è¶Šå¥½ï¼‰
                if (aBestShanten !== bBestShanten) {
                    return aBestShanten - bBestShanten;
                }
                
                // å‘å¬æ•°ç›¸åŒæ—¶ï¼ŒæŒ‰å‰©ä½™æšæ•°æ’åºï¼ˆè¶Šå¤šè¶Šå¥½ï¼‰
                const aRemainingCount = calculateRemainingTiles(a, hand, melds);
                const bRemainingCount = calculateRemainingTiles(b, hand, melds);
                
                if (aRemainingCount !== bRemainingCount) {
                    return bRemainingCount - aRemainingCount;
                }
                
                // æœ€åæŒ‰èŠ±è‰²å’Œæ•°å­—æ’åº
                return sortTilesBySuitAndNumber(a, b);
            });
            
            sortedDrawTiles.forEach(drawTile => {
                const drawUnicode = convertTilesToUnicode(drawTile);
                const options = drawTileOptions.get(drawTile);
                
                // æ‰¾åˆ°è¿™å¼ æ‘¸ç‰Œçš„æœ€ä¼˜é€‰æ‹©
                const bestOption = options.reduce((best, current) => 
                    current.shanten < best.shanten ? current : best
                );
                
                const shantenReduction = currentShanten - bestOption.shanten;
                
                // è®¡ç®—è¯¥æ‘¸ç‰Œçš„å‰©ä½™æšæ•°
                const remainingCount = calculateRemainingTiles(drawTile, hand, melds);
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºæœ€ä¼˜é€‰æ‹©ï¼ˆæœ€ä¼˜å‘å¬æ•°ä¸”æœ€å¤šå‰©ä½™æšæ•°ï¼‰
                const isOptimal = bestOption.shanten === bestShanten && remainingCount === bestRemainingCount;
                
                html += `
                    <div class="shanten-tile draw-tile ${isOptimal ? 'optimal' : ''}" 
                         onclick="applyDrawTileChoice('${drawTile}', '${hand}', '${melds}')">
                        <div class="tile-action-indicator">æ‘¸å…¥</div>
                        <div class="tile-display-large">${drawUnicode}</div>
                        <div class="tile-info">
                            ${bestOption.shanten}å‘å¬
                            ${shantenReduction > 0 ? ` (-${shantenReduction})` : ''}
                        </div>
                        <div class="tile-details">
                            å‰©ä½™${remainingCount}æš
                            ${isOptimal ? '<br>â­ æœ€å¯èƒ½' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            replacePlansDiv.innerHTML = html;
        }

        // å¤„ç†ç‚¹å‡»äº‹ä»¶çš„è¾…åŠ©å‡½æ•°
        function applyDiscardChoice(discardTile, resultingHand) {
            // åœ¨14å¼ ç‰Œæ¨¡å¼ä¸‹ï¼Œæ›´æ–°æ‰‹ç‰Œè¾“å…¥å¹¶æ¸…ç©ºæ‘¸ç‰Œè¾“å…¥
            document.getElementById('tenpaiHandInput').value = resultingHand;
            document.getElementById('tenpaiInInput').value = '';
            
            // æ›´æ–°æ˜¾ç¤ºå¹¶é‡æ–°è®¡ç®—
            updateTenpaiDisplay();
            calculateTenpai();
            
            showNotification(`å·²æ‰“å‡º: ${convertTilesToUnicode(discardTile)}`);
        }

        function applyDrawTileChoice(drawTile, originalHand, melds) {
            // åœ¨13å¼ ç‰Œæ¨¡å¼ä¸‹ï¼Œè®¾ç½®æ‘¸ç‰Œå¹¶è½¬æ¢ä¸º14å¼ ç‰Œæ¨¡å¼
            document.getElementById('tenpaiInInput').value = drawTile;
            
            // æ›´æ–°æ˜¾ç¤º
            updateTenpaiDisplay();
            
            showNotification(`æ‘¸å…¥: ${convertTilesToUnicode(drawTile)}`);
            
            // é‡æ–°è®¡ç®—ï¼ˆç°åœ¨æ˜¯14å¼ ç‰Œæ¨¡å¼ï¼‰
            setTimeout(() => calculateTenpai(), 100);
        }

        // å·¥å…·å‡½æ•°
        function getUniqueTilesFromHand(handTiles) {
            const uniqueTiles = [];
            const seen = new Set();
            
            for (const tile of handTiles) {
                const tileString = tileObjectToString(tile);
                if (!seen.has(tileString)) {
                    seen.add(tileString);
                    uniqueTiles.push(tile);
                }
            }
            
            return uniqueTiles;
        }

        // è®¡ç®—å‰©ä½™ç‰Œæ•°
        function calculateRemainingTiles(tileString, currentHand, melds) {
            try {
                // æ¯ç§ç‰Œçš„æ€»æ•°é‡ï¼ˆæ ‡å‡†éº»å°†ï¼‰
                const totalCount = 4;
                
                // è§£æå½“å‰æ‰‹ç‰Œå’Œå‰¯éœ²ä¸­çš„æ‰€æœ‰ç‰Œ
                const handTiles = mahjongParser.parseHand(currentHand);
                const meldTiles = melds ? mahjongParser.parseHand(melds) : [];
                const allUsedTiles = [...handTiles, ...meldTiles];
                
                // è®¡ç®—ç›®æ ‡ç‰Œåœ¨å·²ä½¿ç”¨ç‰Œä¸­çš„æ•°é‡
                let usedCount = 0;
                const targetTile = mahjongParser.parseHand(tileString)[0];
                
                for (const tile of allUsedTiles) {
                    if (tile.suit === targetTile.suit && tile.number === targetTile.number) {
                        usedCount++;
                    }
                }
                
                return Math.max(0, totalCount - usedCount);
            } catch (error) {
                console.warn('è®¡ç®—å‰©ä½™ç‰Œæ•°å¤±è´¥:', error);
                return 0;
            }
        }

        function tileObjectToString(tile) {
            const suitMap = {
                'man': 'm',
                'pin': 'p',
                'sou': 's',
                'honor': 'z',
                'flower': 'f'
            };
            return `${tile.number}${suitMap[tile.suit] || ''}`;
        }

        function removeOneTileFromHand(handString, tileToRemove) {
            const handTiles = mahjongParser.parseHand(handString);
            
            // æ‰¾åˆ°å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªåŒ¹é…çš„ç‰Œ
            for (let i = 0; i < handTiles.length; i++) {
                if (tileObjectToString(handTiles[i]) === tileToRemove) {
                    handTiles.splice(i, 1);
                    break;
                }
            }
            
            // é‡æ–°ç»„è£…æ‰‹ç‰Œå­—ç¬¦ä¸²
            return formatTilesToString(handTiles);
        }

        function formatTilesToString(tiles) {
            // æŒ‰èŠ±è‰²åˆ†ç»„
            const groups = {
                man: [],
                pin: [],
                sou: [],
                honor: [],
                flower: []
            };
            
            tiles.forEach(tile => {
                if (groups[tile.suit]) {
                    groups[tile.suit].push(tile.number);
                }
            });
            
            // å¯¹æ¯ç§èŠ±è‰²å†…çš„ç‰Œè¿›è¡Œæ’åº
            for (const suit in groups) {
                groups[suit].sort((a, b) => a - b);
            }
            
            // æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
            let result = '';
            if (groups.man.length > 0) result += groups.man.join('') + 'm';
            if (groups.pin.length > 0) result += groups.pin.join('') + 'p';
            if (groups.sou.length > 0) result += groups.sou.join('') + 's';
            if (groups.honor.length > 0) result += groups.honor.join('') + 'z';
            if (groups.flower.length > 0) result += groups.flower.join('') + 'f';
            
            return result;
        }

        // è§£æç‰Œçš„æ ¼å¼ç”¨äºæ’åº
        function parseTileForSort(tileString) {
            if (!tileString || tileString.length < 2) {
                return { suit: 'unknown', number: 0 };
            }
            
            const number = parseInt(tileString.slice(0, -1));
            const suit = tileString.slice(-1);
            
            return { suit, number };
        }

        // æŒ‰èŠ±è‰²å’Œæ•°å­—æ’åºç‰Œ
        function sortTilesBySuitAndNumber(tileA, tileB) {
            const aParsed = parseTileForSort(tileA);
            const bParsed = parseTileForSort(tileB);
            
            // èŠ±è‰²æ’åºä¼˜å…ˆçº§ï¼šm < p < s < z < f
            const suitOrder = { 'm': 1, 'p': 2, 's': 3, 'z': 4, 'f': 5 };
            const aSuitOrder = suitOrder[aParsed.suit] || 6;
            const bSuitOrder = suitOrder[bParsed.suit] || 6;
            
            if (aSuitOrder !== bSuitOrder) {
                return aSuitOrder - bSuitOrder;
            }
            
            // èŠ±è‰²ç›¸åŒæ—¶æŒ‰æ•°å­—æ’åº
            return aParsed.number - bParsed.number;
        }

        // åœ¨æŒ‡å®šå…ƒç´ ä¸­æ˜¾ç¤ºç»“æœæ¶ˆæ¯
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error(`Element with id '${elementId}' not found`);
                return;
            }
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            element.innerHTML = '';
            
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.style.cssText = `
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                margin: 10px 0;
                padding: 10px 15px;
                border-radius: 4px;
                font-size: 14px;
                z-index: auto;
                animation: none;
                max-width: 100%;
                box-shadow: none;
            `;
            
            // è®¾ç½®æ¶ˆæ¯å†…å®¹
            if (message.includes('<')) {
                // å¦‚æœæ¶ˆæ¯åŒ…å«HTMLæ ‡ç­¾ï¼Œåˆ™ä½¿ç”¨innerHTML
                messageDiv.innerHTML = message;
            } else {
                // å¦åˆ™ä½¿ç”¨textContent
                messageDiv.textContent = message;
            }
            
            // æ·»åŠ åˆ°ç›®æ ‡å…ƒç´ 
            element.appendChild(messageDiv);
            
            // ä¸ºæŸäº›å…ƒç´ ç±»å‹æ·»åŠ è‡ªåŠ¨æ¸…é™¤åŠŸèƒ½
            if (type === 'success' && (elementId === 'ruleInfo' || elementId === 'tenpaiResult')) {
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 1000;
                font-size: 14px;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        // æµ‹è¯•åˆ†æ•°è®¡ç®—
        function testScoreCalculation() {
            if (!currentRuleSystem) {
                showResult('scoreResult', 'è¯·å…ˆé€‰æ‹©è§„åˆ™ç³»ç»Ÿ', 'error');
                return;
            }

            const winner = document.getElementById('winner').value;
            const payer = document.getElementById('payer').value;
            const fanCount = parseInt(document.getElementById('fanCount').value) || 0;
            const fuCount = parseInt(document.getElementById('fuCount').value) || 0;
            const winType = document.getElementById('winType').value;

            try {
                const scores = currentRuleSystem.calculateScores(
                    winner, [payer], fanCount, fuCount, winType, false
                );

                let resultHtml = '<h4>åˆ†æ•°å˜åŒ–:</h4>';
                scores.forEach(score => {
                    resultHtml += `<p><strong>${score.player}:</strong> ${score.change > 0 ? '+' : ''}${score.change}</p>`;
                });

                showResult('scoreResult', resultHtml, 'success');

            } catch (error) {
                showResult('scoreResult', `è®¡ç®—é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å‘å¬æ•°è®¡ç®—çš„ç¤ºä¾‹å‡½æ•°
        function testShantenCalculation() {
            // è®¾ç½®ä¸€ä¸ªå…¸å‹çš„éå¬ç‰Œæ‰‹ç‰Œè¿›è¡Œæµ‹è¯•
            const testHand = '123m456p78s11223z'; // 1å‘å¬
            document.getElementById('tenpaiHandInput').value = testHand;
            document.getElementById('tenpaiInInput').value = ''; // æ¸…ç©ºæ‘¸ç‰Œ
            document.getElementById('tenpaiMeldsInput').value = ''; // æ¸…ç©ºå‰¯éœ²
            updateTenpaiDisplay();
            calculateTenpai();
        }

        // åœ¨é¡µé¢ä¸Šæ·»åŠ æµ‹è¯•æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
        function addTestButton() {
            const testSection = document.querySelector('.test-section h2');
            if (testSection && testSection.textContent === 'å¬ç‰Œè®¡ç®—') {
                const testButton = document.createElement('button');
                testButton.textContent = 'æµ‹è¯•13å¼ ç‰Œå‘å¬';
                testButton.style.marginLeft = '10px';
                testButton.onclick = testShantenCalculation;
                testSection.parentNode.appendChild(testButton);
                
                const testButton14 = document.createElement('button');
                testButton14.textContent = 'æµ‹è¯•14å¼ ç‰Œé€‰æ‹©';
                testButton14.style.marginLeft = '10px';
                testButton14.onclick = testShantenCalculation14;
                testSection.parentNode.appendChild(testButton14);
            }
        }

        // æµ‹è¯•14å¼ ç‰Œçš„å‘å¬è®¡ç®—
        function testShantenCalculation14() {
            const testHand = '123m456p78s11223z';
            const testDraw = '6s';
            document.getElementById('tenpaiHandInput').value = testHand;
            document.getElementById('tenpaiInInput').value = testDraw;
            document.getElementById('tenpaiMeldsInput').value = '';
            updateTenpaiDisplay();
            calculateTenpai();
        }
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function () {
            initializeApp();
        };

        // åˆå§‹åŒ–è§„åˆ™ç³»ç»Ÿ
        function initializeRuleSystems() {
            // æ¸…ç©ºå·²æœ‰çš„è§„åˆ™ç³»ç»Ÿ
            availableRuleSystems = {};

            // åŠ¨æ€æ£€æµ‹å’Œæ³¨å†Œæ‰€æœ‰å¯ç”¨çš„è§„åˆ™ç³»ç»Ÿç±»
            const ruleClasses = {
                'chinese-classical-var': ChineseClassicalMahjongVar,
                'japanese': JapaneseMahjong,
                'hong-kong-mahjong': HongKongMahjong
                // æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šè§„åˆ™ç³»ç»Ÿï¼Œæ— éœ€ä¿®æ”¹å…¶ä»–ä»£ç 
            };

            // æ³¨å†Œæ‰€æœ‰å­˜åœ¨çš„è§„åˆ™ç³»ç»Ÿ
            Object.entries(ruleClasses).forEach(([key, RuleClass]) => {
                if (typeof RuleClass !== 'undefined') {
                    availableRuleSystems[key] = new RuleClass();
                    console.log(`å·²æ³¨å†Œè§„åˆ™ç³»ç»Ÿ: ${key} - ${availableRuleSystems[key].name}`);
                }
            });

            // å¡«å……è§„åˆ™é€‰æ‹©å™¨
            populateRuleSelector();

            // è®¾ç½®é»˜è®¤è§„åˆ™
            const defaultRuleKey = Object.keys(availableRuleSystems)[0];
            if (defaultRuleKey) {
                currentRuleSystem = availableRuleSystems[defaultRuleKey];
            }

            // åˆå§‹åŒ–UIæ§åˆ¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (typeof UIController !== 'undefined') {
                uiController = new UIController();
            }
        }

        // å¡«å……è§„åˆ™é€‰æ‹©å™¨
        function populateRuleSelector() {
            const selector = document.getElementById('ruleSelector');
            if (!selector) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '';

            // æ·»åŠ æ‰€æœ‰å¯ç”¨çš„è§„åˆ™ç³»ç»Ÿ
            Object.entries(availableRuleSystems).forEach(([key, ruleSystem]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = ruleSystem.name;
                selector.appendChild(option);
            });
        }

        // è¿™ä¸ªswitchRuleå‡½æ•°æ˜¯é‡å¤çš„ï¼Œä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ä¸»å‡½æ•°

        // è¿™ä¸ªdisplayRuleInfoå‡½æ•°æ˜¯é‡å¤çš„ï¼Œä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ä¸»å‡½æ•°

        // æ›´æ–°ç‰Œå‹æ˜¾ç¤º
        function updateTileDisplay() {
            const hand = document.getElementById('handInput').value;
            const winTile = document.getElementById('winTileInput').value;
            const melds = document.getElementById('meldsInput').value;

            updateDisplayForInputs('tileDisplay', hand, winTile, melds);
        }

        // æ›´æ–°å¬ç‰Œæ˜¾ç¤º
        function updateTenpaiDisplay() {
            const hand = document.getElementById('tenpaiHandInput').value;
            const melds = document.getElementById('tenpaiMeldsInput').value;
            const inTile = document.getElementById('tenpaiInInput').value;

            updateDisplayForInputs('tenpaiTileDisplay', hand, inTile, melds, true);
        }

        // é€šç”¨æ˜¾ç¤ºæ›´æ–°å‡½æ•°
        function updateDisplayForInputs(displayId, hand, winTile, melds, isInTile = false) {
            const displayDiv = document.getElementById(displayId);

            let displayContent = '';
            if (hand) {
                displayContent += `<div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(hand)}</div>`;
            }
            if (winTile) {
                const label = isInTile ? 'æ‘¸ç‰Œ:' : 'å’Œç‰Œ:';
                displayContent += `<div class="tile-section"><span class="tile-label">${label}</span>${convertTilesToUnicode(winTile)}</div>`;
            }
            if (melds) {
                const meldGroups = melds.split(',');
                const meldDisplay = meldGroups.map(meld => convertTilesToUnicode(meld.trim())).join(' | ');
                displayContent += `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${meldDisplay}</div>`;
            }

            displayDiv.innerHTML = displayContent || '<span style="color: #999;">è¯·è¾“å…¥ç‰Œå‹ä»¥æŸ¥çœ‹Unicodeæ˜¾ç¤º</span>';
        }

        // è®¡ç®—å¬ç‰Œ
        function calculateTenpai() {
            const hand = document.getElementById('tenpaiHandInput').value;
            const melds = document.getElementById('tenpaiMeldsInput').value;

            if (!hand.trim()) {
                showErrorAndHideResults('è¯·è¾“å…¥æ‰‹ç‰Œ');
                return;
            }

            try {
                // è·å–æ¸¸æˆçŠ¶æ€
                const conditions = getTenpaiConditions();

                // é¦–å…ˆå°è¯•è®¡ç®—å¬ç‰Œ
                const tenpaiResults = calculateAllTenpaiTiles(hand, melds, conditions);

                if (tenpaiResults.length > 0) {
                    // æ˜¯å¬ç‰Œï¼Œæ˜¾ç¤ºå¬ç‰Œç»“æœ
                    showTenpaiResult();
                    const resultDiv = document.getElementById('tenpaiResult');
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>å¬ç‰Œåˆ†æç»“æœ:</h4>
                        <p style="color: green;">âœ“ å‘ç° ${tenpaiResults.length} ç§å¬ç‰Œ</p>
                        <div class="tenpai-grid">
                            ${tenpaiResults.map((result, index) => {
                                const specialType = currentRuleSystem.getSpecialFanType ? currentRuleSystem.getSpecialFanType(result.fan) : null;
                                const fanDisplay = specialType ? specialType.name : `${result.fan}ç¿»`;
                                return `
                                <div class="tenpai-item" onclick="showTenpaiDetailNew(${index}, ${JSON.stringify(result).replace(/"/g, '&quot;')})">
                                    <div class="tenpai-tile">${convertTilesToUnicode(result.tile)}</div>
                                    <div class="tenpai-value">
                                        ${fanDisplay} ${result.fu}å‰¯<br>
                                        ${result.points}ç‚¹
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                        ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    // ä¸æ˜¯å¬ç‰Œï¼Œè®¡ç®—å‘å¬æ•°
                    if (shantenCalculator && currentRuleSystem) {
                        calculateAndDisplayShanten(hand, melds, conditions);
                    } else {
                        showErrorAndHideResults('å‘å¬æ•°è®¡ç®—åŠŸèƒ½ä¸å¯ç”¨');
                    }
                }
            } catch (error) {
                showErrorAndHideResults(`è®¡ç®—é”™è¯¯: ${error.message}`);
            }
        }

        // è·å–å¬ç‰Œè®¡ç®—çš„æ¡ä»¶
        function getTenpaiConditions() {
            return {
                isZimo: false,
                isGangshangkaihua: false,
                isHaidiLaoyue: false,
                isQiangGang: false,
                isTenhou: false,
                isChiihou: false,
                roundWind: document.getElementById('tenpaiRoundWind').value,
                playerWind: document.getElementById('tenpaiPlayerWind').value 
            };
        }

        // è®¡ç®—æ‰€æœ‰å¯èƒ½çš„å¬ç‰Œç“¦
        function calculateAllTenpaiTiles(hand, melds, conditions) {
            const results = [];

            // æ‰€æœ‰å¯èƒ½çš„ç‰Œ
            const allTiles = [
                '1m', '2m', '3m', '4m', '5m', '6m', '7m', '8m', '9m',
                '1p', '2p', '3p', '4p', '5p', '6p', '7p', '8p', '9p',
                '1s', '2s', '3s', '4s', '5s', '6s', '7s', '8s', '9s',
                '1z', '2z', '3z', '4z', '5z', '6z', '7z'
            ];

            for (const tile of allTiles) {
                try {
                    if (currentRuleSystem && currentRuleSystem.calculateHandValue) {

                        const result = currentRuleSystem.calculateHandValue(hand, tile, melds, conditions);
                        if (result && result.fan !== undefined && result.fu !== undefined) {
                            // è®¡ç®—ç‚¹æ•°
                            let points = result.fu + result.fan * 10;
                            if (currentRuleSystem.calculateBasePoints) {
                                points = currentRuleSystem.calculateBasePoints(result.fan, result.fu);
                            }

                            results.push({
                                tile: tile,
                                fan: result.fan,
                                fu: result.fu,
                                points: points,
                                fanDetails: result.fanDetails || [],
                                fuDetails: result.fuDetails || []
                            });
                        }
                    }
                } catch (error) {
                    // å¿½ç•¥æ— æ•ˆçš„ç‰Œå‹
                    continue;
                }
            }

            return results.sort((a, b) => b.points - a.points); // æŒ‰ç‚¹æ•°é™åºæ’åˆ—
        }

        // æ›´æ–°å’Œç‰Œæ¡ä»¶
        function updateWinConditions() {
            if (!currentRuleSystem) return;

            const conditionsContainer = document.getElementById('win-conditions-analysis');
            if (!conditionsContainer) return;

            // æ¸…ç©ºç°æœ‰æ¡ä»¶
            conditionsContainer.innerHTML = '';

            // è·å–æ”¯æŒçš„æ¡ä»¶
            const conditions = currentRuleSystem.getSupportedWinConditions ? 
                              currentRuleSystem.getSupportedWinConditions() : [];

            conditions.forEach(condition => {
                const label = document.createElement('label');

                // åœˆé£ã€é—¨é£ç­‰è‡ªåŠ¨å‚æ•°ä¸æ˜¾ç¤ºåœ¨UIä¸­ï¼Œç”±æ¸¸æˆçŠ¶æ€è‡ªåŠ¨æä¾›
                if (condition.hide === true) {
                    return; // è·³è¿‡è‡ªåŠ¨å‚æ•°
                }

                if (condition.type === 'number') {
                    // æ•°å­—è¾“å…¥
                    label.innerHTML = `
                        <span>${condition.label}ï¼š</span>
                        <input type="number" id="${condition.key}" 
                               min="${condition.min || 0}" 
                               max="${condition.max || 99}" 
                               value="${condition.default || 0}">
                    `;
                } else {
                    // å¤é€‰æ¡†
                    label.innerHTML = `
                        <input type="checkbox" id="${condition.key}" ${condition.default ? 'checked' : ''}> 
                        ${condition.label}
                    `;
                }

                conditionsContainer.appendChild(label);
            });
        }

        // æµ‹è¯•ç‰Œå‹åˆ†æ
        function testHandAnalysis() {
            const hand = document.getElementById('handInput').value;
            const winTile = document.getElementById('winTileInput').value;
            const melds = document.getElementById('meldsInput').value;

            if (!currentRuleSystem) {
                showResult('analysisResult', 'è¯·å…ˆé€‰æ‹©è§„åˆ™ç³»ç»Ÿ', 'error');
                return;
            }

            if (!currentRuleSystem.calculateHandValue) {
                showResult('analysisResult', 'å½“å‰è§„åˆ™ç³»ç»Ÿä¸æ”¯æŒè‡ªåŠ¨åˆ†æ', 'error');
                return;
            }

            // åŠ¨æ€æ”¶é›†å’Œç‰Œæ¡ä»¶
            const conditions = {};

            const isZimo = document.getElementById("win-cond-zimo").checked;
            
            // è·å–æ”¯æŒçš„æ¡ä»¶
            const supportedConditions = currentRuleSystem.getSupportedWinConditions ? 
                                       currentRuleSystem.getSupportedWinConditions() : [];
            
            // ä»UIä¸­è¯»å–æ¡ä»¶å€¼
            supportedConditions.forEach(condition => {
                const element = document.getElementById(condition.key);
                if (element) {
                    if (element.type === 'checkbox') {
                        conditions[condition.key] = element.checked;
                    } else if (element.type === 'number') {
                        conditions[condition.key] = parseInt(element.value) || 0;
                    } else {
                        conditions[condition.key] = element.value;
                    }
                } else {
                    // ä½¿ç”¨é»˜è®¤å€¼
                    conditions[condition.key] = condition.default;
                }
            });

            conditions["isZimo"] = isZimo;
            conditions["isTsumo"] = isZimo;

            // æ·»åŠ é£ç‰Œä¿¡æ¯
            conditions.roundWind = document.getElementById('roundWind').value;
            conditions.playerWind = document.getElementById('playerWind').value;

            try {
                if (!currentRuleSystem || !currentRuleSystem.calculateHandValue) {
                    throw new Error('å½“å‰è§„åˆ™ç³»ç»Ÿä¸æ”¯æŒç‰Œå‹åˆ†æ');
                }

                const result = currentRuleSystem.calculateHandValue(hand, winTile, melds, conditions);

                const resultDiv = document.getElementById('analysisResult');
                resultDiv.className = 'result success';

                // è®¡ç®—æœ€ç»ˆç‚¹æ•°
                let finalPoints = result.fu + result.fan * 10;
                if (currentRuleSystem.calculateBasePoints) {
                    finalPoints = currentRuleSystem.calculateBasePoints(result.fan, result.fu);
                }

                // æ˜¾ç¤ºç‰Œå‹ä¿¡æ¯
                const tileInfo = `
                    <div class="tile-display">
                        ${hand ? `<div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(hand)}</div>` : ''}
                        ${winTile ? `<div class="tile-section"><span class="tile-label">å’Œç‰Œ:</span>${convertTilesToUnicode(winTile)}</div>` : ''}
                        ${melds ? `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${melds.split(',').map(meld => convertTilesToUnicode(meld.trim())).join(' | ')}</div>` : ''}
                    </div>
                `;

                // æ„å»ºç¿»æ•°è¯¦æƒ…
                let fanDetailsHtml = '';
                if (result.fanDetails && result.fanDetails.length > 0) {
                    fanDetailsHtml = `
                        <div style="margin-top: 15px;">
                            <h5 style="color: #007cba; margin-bottom: 10px;">ç¿»æ•°è¯¦æƒ…:</h5>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #007cba;">
                                ${result.fanDetails.map(detail => {
                                    // å¦‚æœdetail.fanä¸æ˜¯æ•°å­—ï¼Œè¯´æ˜å·²ç»è¢«æ ¼å¼åŒ–ï¼Œç›´æ¥æ˜¾ç¤º
                                    const fanDisplay = typeof detail.fan === 'number' ? `${detail.fan}ç¿»` : detail.fan;
                                    return `
                                    <div style="margin-bottom: 8px; padding: 5px; background: white; border-radius: 3px;">
                                        <strong style="color: #007cba;">${detail.name}</strong>: 
                                        <span style="color: #d63384; font-weight: bold;">${fanDisplay}</span>
                                        ${detail.description ? `<br><small style="color: #666;">${detail.description}</small>` : ''}
                                    </div>
                                    `;
                                }).join('')}
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-weight: bold;">
                                    æ€»è®¡ç¿»æ•°: <span style="color: #d63384;">${currentRuleSystem.getSpecialFanType && currentRuleSystem.getSpecialFanType(result.fan) ? currentRuleSystem.getSpecialFanType(result.fan).name : result.fan + 'ç¿»'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // æ„å»ºå‰¯æ•°è¯¦æƒ…
                let fuDetailsHtml = '';
                if (result.fuDetails && result.fuDetails.length > 0) {
                    fuDetailsHtml = `
                        <div style="margin-top: 15px;">
                            <h5 style="color: #28a745; margin-bottom: 10px;">å‰¯æ•°è¯¦æƒ…:</h5>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;">
                                ${result.fuDetails.map(detail => {
                                    // å¦‚æœdetail.fuä¸æ˜¯æ•°å­—ï¼Œè¯´æ˜å·²ç»è¢«æ ¼å¼åŒ–ï¼Œç›´æ¥æ˜¾ç¤º
                                    const fuDisplay = typeof detail.fu === 'number' ? `${detail.fu}å‰¯` : detail.fu;
                                    return `
                                    <div style="margin-bottom: 8px; padding: 5px; background: white; border-radius: 3px;">
                                        <strong style="color: #28a745;">${detail.name}</strong>: 
                                        <span style="color: #fd7e14; font-weight: bold;">${fuDisplay}</span>
                                        ${detail.description ? `<br><small style="color: #666;">${detail.description}</small>` : ''}
                                    </div>
                                    `;
                                }).join('')}
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-weight: bold;">
                                    æ€»è®¡å‰¯æ•°: <span style="color: #fd7e14;">${result.fu}å‰¯</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    ${tileInfo}
                    <h4>ç¿»å‰¯åˆ†æç»“æœ:</h4>
                    <p style="color: green;"><strong>âœ“ ç‰Œå‹æœ‰æ•ˆ</strong></p>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-size: 18px;">
                                <strong>ç¿»æ•°:</strong> 
                                <span style="color: #d63384; font-size: 20px; font-weight: bold;">
                                    ${currentRuleSystem.getSpecialFanType && currentRuleSystem.getSpecialFanType(result.fan) ? currentRuleSystem.getSpecialFanType(result.fan).name : result.fan + 'ç¿»'}
                                </span>
                            </div>
                            <div style="font-size: 18px;">
                                <strong>å‰¯æ•°:</strong> 
                                <span style="color: #fd7e14; font-size: 20px; font-weight: bold;">${result.fu}å‰¯</span>
                            </div>
                        </div>
                        <div style="text-align: center; font-size: 20px; font-weight: bold; color: #007cba;">
                            æ€»ç‚¹æ•°: ${finalPoints}ç‚¹
                        </div>
                    </div>
                    ${fanDetailsHtml}
                    ${fuDetailsHtml}
                `;

            } catch (error) {
                const resultDiv = document.getElementById('analysisResult');
                resultDiv.className = 'result error';
                console.log (error)

                // æ˜¾ç¤ºç‰Œå‹ä¿¡æ¯ï¼ˆå³ä½¿æ˜¯è¯ˆèƒ¡ä¹Ÿè¦æ˜¾ç¤ºï¼‰
                let tileInfo = '';
                if (hand || winTile || melds) {
                    tileInfo = `
                        <div class="tile-display">
                            ${hand ? `<div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(hand)}</div>` : ''}
                            ${winTile ? `<div class="tile-section"><span class="tile-label">å’Œç‰Œ:</span>${convertTilesToUnicode(winTile)}</div>` : ''}
                            ${melds ? `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${melds.split(',').map(meld => convertTilesToUnicode(meld.trim())).join(' | ')}</div>` : ''}
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    ${tileInfo}
                    <h4>åˆ†æç»“æœ:</h4>
                    <p style="color: red; font-weight: bold;">âœ— ${error.message}</p>
                `;
            }
        }

        // æµ‹è¯•åˆ†æ•°è®¡ç®—
        function testScoreCalculation() {
            const winner = document.getElementById('winner').value;
            const payer = document.getElementById('payer').value;
            const fanCount = parseInt(document.getElementById('fanCount').value) || 0;
            const fuCount = parseInt(document.getElementById('fuCount').value) || 0;
            const winType = document.getElementById('winType').value;

            try {
                if (!currentRuleSystem || !currentRuleSystem.calculateScores) {
                    throw new Error('å½“å‰è§„åˆ™ç³»ç»Ÿä¸æ”¯æŒåˆ†æ•°è®¡ç®—');
                }

                const scores = currentRuleSystem.calculateScores(
                    winner, [payer], fanCount, fuCount, winType, 'east'
                );

                const resultDiv = document.getElementById('scoreResult');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>åˆ†æ•°å˜åŒ–:</h4>
                    ${scores.map(score =>
                    `<p><strong>${score.player}:</strong> ${score.change > 0 ? '+' : ''}${score.change}</p>`
                ).join('')}
                `;
            } catch (error) {
                const resultDiv = document.getElementById('scoreResult');
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<p>é”™è¯¯: ${error.message}</p>`;
            }
        }

        // æµ‹è¯•é¢„è®¾ç‰Œå‹
        function testPresetHands(type) {
            const resultDiv = document.getElementById('presetResult');
            let testCase;

            switch (type) {
                case 'duiduihu':
                    testCase = {
                        name: 'å¯¹å¯¹å’Œ',
                        hand: '111m222p33344s44z',
                        winTile: '4z',
                        melds: '',
                        conditions: { isZimo: false }
                    };
                    break;
                case 'qingyise':
                    testCase = {
                        name: 'æ¸…ä¸€è‰²',
                        hand: '123456778899m1m',
                        winTile: '1m',
                        melds: '',
                        conditions: { isZimo: false }
                    };
                    break;
                case 'dasanyuan':
                    testCase = {
                        name: 'å¤§ä¸‰å…ƒ',
                        hand: '555z666z777z55s11m',
                        winTile: '1m',
                        melds: '',
                        conditions: { isZimo: false }
                    };
                    break;
                case 'zimohua':
                    testCase = {
                        name: 'è‡ªæ‘¸+èŠ±ç‰Œ',
                        hand: '123m456p789s555z1z',
                        winTile: '1z',
                        melds: '1234f',
                        conditions: { isZimo: true }
                    };
                    break;
                case 'windtest':
                    testCase = {
                        name: 'é£ç‰Œæµ‹è¯•',
                        hand: '123m456p789s11z77z',
                        winTile: '1z',
                        melds: '',
                        conditions: {
                            isZimo: false,
                            roundWind: 1,
                            playerWind: 1
                        }
                    };
                    break;
                case 'zhahu':
                    testCase = {
                        name: 'è¯ˆèƒ¡æµ‹è¯•',
                        hand: '123m456p78s112z',
                        winTile: '3z',
                        melds: '',
                        conditions: { isZimo: false },
                        shouldFail: true
                    };
                    break;
            }

            try {
                if (!currentRuleSystem || !currentRuleSystem.calculateHandValue) {
                    throw new Error('å½“å‰è§„åˆ™ç³»ç»Ÿä¸æ”¯æŒç‰Œå‹åˆ†æ');
                }

                // è®¾ç½®é£ç‰Œä¿¡æ¯åˆ°UIï¼ˆå¦‚æœæµ‹è¯•ç”¨ä¾‹æœ‰æŒ‡å®šï¼‰
                if (testCase.conditions.roundWind) {
                    document.getElementById('roundWind').value = testCase.conditions.roundWind;
                }
                if (testCase.conditions.playerWind) {
                    document.getElementById('playerWind').value = testCase.conditions.playerWind;
                }

                const result = currentRuleSystem.calculateHandValue(
                    testCase.hand, testCase.winTile, testCase.melds, testCase.conditions
                );

                if (testCase.shouldFail) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>${testCase.name} æµ‹è¯•ç»“æœ:</h4>
                        <p style="color: orange;">âš ï¸ è­¦å‘Šï¼šæœŸæœ›è¯ˆèƒ¡ä½†é€šè¿‡äº†éªŒè¯</p>
                    `;
                    return;
                }

                // è®¡ç®—æœ€ç»ˆç‚¹æ•°
                let finalPoints = result.fu + result.fan * 10;
                if (currentRuleSystem.calculateBasePoints) {
                    finalPoints = currentRuleSystem.calculateBasePoints(result.fan, result.fu);
                }

                // æ˜¾ç¤ºç‰Œå‹ä¿¡æ¯
                const tileInfo = `
                    <div class="tile-display">
                        <div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(testCase.hand)}</div>
                        <div class="tile-section"><span class="tile-label">å’Œç‰Œ:</span>${convertTilesToUnicode(testCase.winTile)}</div>
                        ${testCase.melds ? `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${convertTilesToUnicode(testCase.melds)}</div>` : ''}
                    </div>
                `;

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    ${tileInfo}
                    <h4>${testCase.name} æµ‹è¯•ç»“æœ:</h4>
                    <p style="color: green;"><strong>âœ“ ç‰Œå‹æœ‰æ•ˆ</strong></p>
                    <p><strong>ç¿»æ•°:</strong> ${result.fan === 100 ? 'æ»¡è´¯' : result.fan === 50 ? 'åŠæ»¡è´¯' : result.fan}</p>
                    <p><strong>å‰¯æ•°:</strong> ${result.fu}</p>
                    <p><strong>æ€»ç‚¹æ•°:</strong> ${finalPoints}ç‚¹</p>
                `;
            } catch (error) {
                if (testCase.shouldFail && error.message.includes('è¯ˆèƒ¡')) {
                    const tileInfo = `
                        <div class="tile-display">
                            <div class="tile-section"><span class="tile-label">æ‰‹ç‰Œ:</span>${convertTilesToUnicode(testCase.hand)}</div>
                            <div class="tile-section"><span class="tile-label">å’Œç‰Œ:</span>${convertTilesToUnicode(testCase.winTile)}</div>
                            ${testCase.melds ? `<div class="tile-section"><span class="tile-label">å‰¯éœ²:</span>${convertTilesToUnicode(testCase.melds)}</div>` : ''}
                        </div>
                    `;

                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ${tileInfo}
                        <h4>${testCase.name} æµ‹è¯•ç»“æœ:</h4>
                        <p style="color: red; font-weight: bold;">âœ— ${error.message}</p>
                        <p style="color: green;">âœ“ è¯ˆèƒ¡æ£€æµ‹æ­£å¸¸å·¥ä½œ</p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<p>é”™è¯¯: ${error.message}</p>`;
                }
            }
        }
    </script>
</body>

</html>